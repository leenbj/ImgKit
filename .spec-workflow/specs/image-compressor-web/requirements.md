# 图片压缩 Web 应用 — 需求规范（Requirements）

版本：v1.0  （规范阶段：Requirements）
规范名：image-compressor-web
文档状态：待评审

## 1. 背景与目标

在日常工作与个人创作中，图片体积过大带来的分享困难、网页加载缓慢与存储成本提升等问题普遍存在。本项目旨在提供一个纯前端、极简部署的图片批量压缩工具，支持用户在浏览器中一次性上传多张图片、按百分比控制压缩强度、快速获得压缩结果，并可单张下载或批量打包下载。UI 风格力求简约现代，交互动画具备“高级感”。

目标摘要：
- 纯前端本地处理，隐私友好，免后端部署。
- 支持批量图片压缩，控制压缩比例（百分比形式）。
- 结果可单张下载或打包 ZIP 下载。
- 简约现代 UI + 高级交互动画，易上手与愉悦体验。
- 可选水印能力（图片/文字），支持斜向平铺与低透明度呈现，不影响原图观感。

## 2. 术语

- 原图：用户上传的未压缩图片。
- 压缩强度（Compression Intensity）：以百分比呈现的压缩程度控制项（数值越大代表压缩越强/体积越小）。
- 压缩质量（Quality）：底层编解码器使用的质量参数（与强度存在映射）。
- 节省比率：压缩后相对原图的体积节省百分比。
- 批量下载：将多张压缩后的图片打包为 ZIP 文件并下载。
- 目标尺寸（Target Size）：导出图片的像素尺寸（宽×高）。
- 目标比例（Aspect Ratio）：导出图片希望达到的宽高比（如 1:1、4:3、16:9）。
- 适配模式（Fit Mode）：Contain（不裁剪，可能留边）/ Cover（填满区域，可能裁剪），均不拉伸变形。
- 水印（Watermark）：叠加在导出结果上的标记元素，分为“图片水印（透明 PNG）”与“文字水印”。
- 斜向平铺（Diagonal Tiling）：按固定角度（如 30°/45°）将水印在图面等距平铺。
- 透明度（Opacity）：水印整体不透明度，默认低透明（约 12%~18%），以“若隐约现”为原则。

## 3. 范围（Scope）

在范围：
- 批量上传图片（拖拽/点击选择）。
- 针对所有图片或单张图片设置压缩强度（百分比）。
- 展示每张图片压缩前后体积与节省百分比；可选预览对比。
- 单张下载与批量 ZIP 下载。
- 纯前端本地处理，无需服务器参与；可静态托管。
- 简约现代 UI 与高级感交互动画（加载、进度、状态切换、按钮微动效等）。
- 尺寸与比例调整：支持设置目标尺寸/比例与适配模式（不变形），并可手动选择裁剪/取景位置。
- 水印：支持图片水印（透明 PNG）与文字水印；支持斜向平铺、透明度/缩放/间距/角度设置；单张或批量应用。

不在范围（v1）：
- 云端存储/分享、登录账号、多端同步。
- 服务端批处理或队列分发。
- 复杂图像编辑（旋转、滤镜等）。
- 智能水印防篡改/盲水印/数字签名（后续可评估）。
- HEIC/RAW 等受限格式的全面支持（可作为后续扩展）。

## 4. 用户画像与场景

- 设计师/产品/开发：需要快速压缩导出的多张设计切图以便投递、发邮件或上传到协作平台。
- 内容创作者/运营：将手机或相机拍摄的多张图片压缩后批量发布。
- 普通用户：为节省存储空间与传输时间，对相册中的若干图片进行简易压缩。

典型使用流程：打开网页 → 拖拽/选择多张图片 → 选择全局压缩强度或逐张微调 → 预览/查看体积节省 → 一键下载（单张或打包 ZIP）。

## 5. 需求分级

- 必须（MUST）：基础可用与隐私本地处理；批量压缩；强度控制；进度与状态；下载与打包；水印（图片/文字，斜向平铺，低透明）。
- 应该（SHOULD）：预览对比（前后滑块/并排）；失败重试与错误提示；基础可访问性与键盘操作。
- 可以（COULD）：格式转换（如可选转 WebP/AVIF）；PWA 安装；多语言。

## 6. 功能需求（Functional Requirements）

FR-01 批量上传
- 支持拖拽与点击选择文件两种方式；
- 至少支持 JPEG、PNG、WebP；其他格式可按浏览器原生/解码器能力渐进支持；
- 单次最多选择 N 张（默认 200，可在设置中调整，防止内存峰值）。

FR-02 文件列表与元数据
- 展示文件名、原始体积、类型、分辨率（宽×高）等；
- 对每个条目显示压缩后体积与节省百分比；
- 提供清空队列、移除单项、重新上传操作。

FR-03 压缩强度控制（百分比）
- 提供全局“压缩强度”滑杆（0%~100%，默认 60%）；
- 支持对单张图片的强度覆盖设置；
- 强度与底层“质量/质量因子”之间存在映射（例如：强度 0% ≈ 质量 95，强度 100% ≈ 质量 30，线性或分段曲线可配置）。
 - 滑动滑杆时在 UI 中实时显示“压缩前大小 / 预计压缩后大小 / 预计节省%”；完成压缩后显示“实际压缩后大小 / 实际节省%”。

FR-04 压缩执行与并发
- 点击“开始压缩”后进入处理队列；
- 支持并发处理（默认 3~4 并发，可根据设备性能自动降级）；
- 显示处理进度（列表项进度条 + 全局进度）。

FR-05 预览与对比（可选但推荐）
- 提供单张图片的压缩前后对比（滑块/并排切换）；
- 预览中显示当前强度、质量与估算/实际体积对比。

FR-06 下载
- 单张下载：生成文件名规则`{原名}-compressed.{ext}`；
- 批量下载：将已完成的多张压缩结果打包为 ZIP，命名规则`compressed-{日期时间}.zip`；
- 支持选择性下载（仅已选项）。

FR-07 错误处理与重试
- 对于解码失败/内存不足/浏览器限制，给出友好提示；
- 允许对失败项进行重试或降低强度后重试。

FR-08 设置与偏好
- 记忆上次的全局强度值；
- 切换主题（浅/深）；
- 动画开关遵循系统“减少动态效果”偏好（Reduced Motion）。

FR-09 隐私与离线
- 处理全部在本地浏览器内进行，不上传至服务器；
- 可在无网络时使用（若使用外部 CDN 资源需提供离线回退，本项目建议本地打包）。

FR-10 可访问性（A11y）
- 键盘可达（上传、开始压缩、下载、强度滑杆可键控）；
- 为重要元素提供语义化标签与 ARIA 属性；
- 对比度达标（WCAG AA）。

FR-11 尺寸与比例调整（不变形）
- 支持设置导出目标尺寸（像素）与目标比例（预设 1:1、4:3、16:9、21:9，支持自定义）；
- 提供适配模式：Contain（不裁剪，可能留边）与 Cover（填满区域，可能裁剪）；
- 严禁拉伸变形：禁止非等比缩放，必要时以留边或裁剪实现目标尺寸/比例；
- 可选开关“禁止放大”：若开启，目标尺寸不超过原图有效像素尺寸（避免低质放大）。

FR-12 裁剪与取景位置
- 在 Cover 模式下，提供交互式裁剪/取景组件，允许用户拖拽移动与缩放取景框；
- 支持对齐锚点（中心/上/下/左/右/四角）与细粒度自由定位；
- 预览实时显示裁剪区域与导出分辨率；
- 单张/全局：可对单张自定义，或对未个性化的图片应用全局取景锚点。

FR-13 批量尺寸应用
- 用户可为全部图片设置统一目标尺寸/比例与适配模式；
- 已被单独编辑过的图片保留其个性化设置；
- 批量应用时提供“仅缩小不放大”选项以保障画质。

FR-14 水印功能（图片/文字，若隐约现）
- 图片水印：支持上传透明底 PNG 作为水印源；
- 文字水印：支持输入文本、选择字体/字重（以系统字体为主）、字号、颜色；
- 布局：支持单次放置（指定位置与缩放）与斜向平铺两种模式；
- 平铺参数：角度（默认 30°或 45°）、间距、缩放、边距；
- 透明度：可调节，默认低透明（约 12%~18%），确保不干扰主要内容；
- 合成顺序：先裁剪/尺寸处理，再叠加水印，最后编码压缩；
- 批量：支持全局统一水印，单张可覆盖或关闭；
- 可访问性：水印面板可键盘操作，参数输入支持数值步进与预设。

## 7. 非功能需求（Non-Functional Requirements）

NFR-01 部署与运维
- 架构支持完全静态托管（GitHub Pages/Netlify/Vercel/静态服务器）；
- 构建产物为纯静态文件（HTML/CSS/JS/WASM）。

NFR-02 性能与容量
- 目标：在中端笔记本（4C/8T，16GB RAM）压缩 100 张、总计约 200MB 的相册在 60 秒内完成；
- 并发可调与自适应降级（根据 `navigator.hardwareConcurrency` 与内存压力）；
- 对超大图（>24MP）或超大文件（>20MB）进行分支处理/提示。

NFR-03 资源与内存管理
- 对象 URL 使用后及时 `revokeObjectURL`；
- 释放中间 ArrayBuffer/Canvas/Bitmap；
- 避免一次性将全部文件解码到内存，采用队列化/分批策略。

NFR-04 前端包体与加载
- 首屏包体（不含编解码器 WASM）≤ 250KB gzip；
- 编解码器（如 mozjpeg/oxipng/libwebp/wasm）懒加载并使用 `Web Worker`；
- 重要交互在 2 秒内可达（LCP ≤ 2.5s）。

NFR-05 兼容性
- 现代浏览器最近两个大版本（Chrome/Edge/Firefox/Safari）；
- 对不支持 WebCodecs/OffscreenCanvas 的环境自动退化到 Canvas 方案。

NFR-06 安全与隐私
- 不上传用户图片数据；
- 内容安全策略（CSP）限制外部资源；
- 错误日志仅记录汇总与栈，默认不包含文件内容与元数据。

NFR-07 体验与动画
- 60 FPS 优先，动画遵循物理缓动；
- 微交互：悬停、按压、完成勾选、进度过渡；
- 遵循“减少动态效果”系统设置，必要时降级为淡入/淡出。

NFR-08 裁剪与尺寸交互性能
- 裁剪取景交互保持流畅（目标 60 FPS），对高分辨率图片采用缩略预览与延迟高精度计算；
- 大图实时预览采用缩放后的工作画布，最终导出使用离屏高精度渲染。

NFR-09 水印性能与观感
- 斜向平铺采用离屏画布生成 pattern 并复用，避免逐元素绘制抖动；
- 文本水印使用 Canvas 文本渲染与抗锯齿，保证清晰细腻；
- 默认低透明且遵循“减少动态效果”时减少动画干扰；
- 小尺寸图自动降低平铺密度与字号，避免画面拥挤。

## 8. 交互与 UI 原则

- 信息层级清晰：上传区（主召唤）、列表区（批量）、控制区（全局/单项强度）、动作区（开始/下载）。
- 布局简约：卡片化列表 + 顶部控制条/底部工具条；
- 现代风格：干净留白、半透明毛玻璃（可选）、柔和阴影、系统色彩变量；
- 动画统一：进入/离开过渡、列表项展开/收起、进度条平滑、按钮涟漪/弹性；
- 可访问：对比度、焦点环、自解释图标 + 文本标签。

新增（尺寸/裁剪）相关交互：
- 目标尺寸与比例选择器（常用预设 + 自定义输入）；
- 适配模式切换（Contain/Cover），附简图说明不变形原则；
- 裁剪取景叠加层：支持拖拽移动/缩放，显示安全区/参考网格（3×3）；
- 键盘微调取景位置与尺寸（可访问）。

新增（水印）相关交互：
- 水印开关与模式选择（图片/文字/关闭）；
- 参数面板：角度、间距、缩放、透明度、边距、位置锚点（单次放置时）；
- 图片水印上传与预览；文字水印字体、字号与颜色选择；
- 预设模板（如“轻淡斜纹”、“更淡、更疏”）一键应用；
- 全局/单张应用切换与状态提示。

（可选）低保真结构草图：

```
┌──────────── 顶部栏：Logo ｜ 压缩强度 全局滑杆 ｜ 主题切换 ｜ 开始压缩 ────────────┐
│                                                                                    │
│  拖拽/点击上传区域（空态动画/插画 + 提示文案）                                      │
│                                                                                    │
├───────────────────────────── 文件列表（卡片） ─────────────────────────────┤
│ [缩略图] 文件名.ext  原始体积 → 压缩后体积（节省%）   单项强度滑杆  预览  删除        │
│ [进度条/状态：等待/处理中/完成/失败]                                              │
│ …                                                                                │
├──────────────────────────────────────────────────────────────────────────────────┤
│ 底部工具条：清空队列 ｜ 选择项下载 ｜ 全部下载（ZIP）                               │
└──────────────────────────────────────────────────────────────────────────────────┘
```

## 9. 验收标准（按 FR 对应）

- AC-01（对应 FR-01）：可一次性选择 ≥ 20 张图片，拖拽/点击均可触发，非支持格式给出提示并忽略。
- AC-02（对应 FR-02）：列表展示每项原始体积、分辨率与类型；压缩完成后显示压缩后体积与节省比率。
- AC-03（对应 FR-03）：全局滑杆变动能实时影响“待压缩预估”；单项覆盖强度后以该值为准。
  - 明确展示“压缩前大小 / 预计压缩后大小 / 预计节省%”；
  - 完成压缩后展示“实际压缩后大小 / 实际节省%”，并可与估算进行对比。
- AC-04（对应 FR-04）：点击“开始压缩”后，显示全局与单项进度；并发处理不阻塞 UI；取消/重试可用。
- AC-05（对应 FR-05）：可打开任一项的前后对比视图，切换流畅，显示清晰无明显伪影（同等查看尺寸）。
- AC-06（对应 FR-06）：单张点击后触发浏览器下载；多张选择后可生成 ZIP 并下载；文件名规则符合约定。
- AC-07（对应 FR-07）：当解码失败/内存不足，提示明确；降低强度或重试后可继续处理；失败项不影响已完成项。
- AC-08（对应 FR-08）：刷新后保留上次全局强度值与主题偏好；减少动态效果时动画自动弱化。
- AC-09（对应 FR-09）：断网情况下仍可完成上传与压缩（依赖本地资源）；不进行任何网络传输。
- AC-10（对应 FR-10）：通过键盘可完成主要操作；关键元素具备 ARIA 与语义；对比度达标。

- AC-11（对应 FR-11）：
  - 用户可从预设或自定义输入目标尺寸/比例；
  - 选择 Contain 时导出不裁剪且不变形（必要时留边）；
  - 选择 Cover 时导出填满目标区域但不变形（必要时裁剪）；
  - 若“禁止放大”开启，则导出尺寸不超过原图像素尺寸。

- AC-12（对应 FR-12/FR-13）：
  - 可交互调整取景位置，导出结果与预览一致；
  - 支持对单张应用个性设置并对其他图片批量应用全局设置；
  - 批量应用不覆盖已个性化的图片设置。

- AC-13（对应 FR-14 水印）：
  - 支持上传透明 PNG 作为水印，并可输入文字作为文字水印；
  - 斜向平铺可配置角度/间距/缩放/边距，默认 30° 或 45°；
  - 默认透明度低（约 12%~18%），整体观感“若隐约现”，不明显干扰主体；
  - 全局开启水印时，单张可个性化覆盖或关闭；
  - 导出图像正确叠加水印，无明显锯齿与色带；
  - 水印与裁剪/尺寸/压缩流程顺序正确（先裁剪缩放，后加水印，再编码）。

## 10. 依赖与技术约束（方向性，不锁定具体实现）

- 前端框架：可选 React/Vue/Svelte/原生（建议选用配套生态成熟、体积可控的方案）。
- 打包工具：Vite（推荐）或同级方案；产物为静态资源。
- 编解码：
  - JPEG：mozjpeg/WASM 或 WebCodecs（可用时）；
  - PNG：oxipng/WASM 或 UPNG.js；
  - WebP/AVIF：libwebp/ libavif 的 WASM 版本或浏览器原生编码接口；
  - 采用 Web Worker + OffscreenCanvas（可用时）隔离计算。
- 打包 ZIP：JSZip（或等效开源库）。
- 文件保存：`a[download]`、File System Access API（可用时）作为增强。

- 尺寸与裁剪：
  - 使用 Canvas/OffscreenCanvas 实现等比缩放与裁剪渲染；
  - 交互层使用 CSS transform + 虚拟化预览，提高流畅度；
 - 导出阶段在 Worker 内进行高分辨率重采样，采用高质量插值（如 Lanczos 或浏览器等效）。

- 水印：
  - 使用离屏 Canvas 生成平铺图案（Pattern），`globalAlpha` 控制透明度；
  - `globalCompositeOperation` 可优先使用 `overlay`/`multiply`，不支持时回退 `source-over`；
  - 文本水印使用 `fillText`/`Path2D` 渲染并结合 `measureText` 做自适应缩放；
  - 参数与状态可序列化，支持全局与单张覆盖；

## 11. 风险与对策

- 大内存峰值：采用队列与分批处理，尽量避免一次性解码；处理完成立即释放资源。
- 移动端兼容：对 iOS/低内存设备降低并发，限制最大尺寸并给出提示。
- WASM 包体：分包懒加载与压缩，必要时按需提供编解码器集合。
- 旧浏览器：回退到 Canvas 方案或提示升级。

## 12. 指标与遥测（本地或可选匿名聚合）

- 使用成功率（完成压缩并下载的会话占比）。
- 平均节省比率与分布（按格式、强度）。
- 压缩失败率与原因（不含文件内容）。
- 平均处理时长（总/每张）。

## 13. 里程碑

- M0（基础）：批量上传、全局强度、压缩与单/批量下载、基础进度与错误提示、简约 UI。
- M1（体验）：单项强度覆盖、预览对比、可访问性达标、主题与偏好、并发自适应。
- M2（高级）：更丰富微交互与动效、水印（图片/文字，斜向平铺），PWA（可选）、格式转换（可选）。

—— 本文档为需求规范（Requirements），通过审批后将进入设计规范（Design）阶段。
